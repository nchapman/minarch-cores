#!/bin/bash
#
# release - Automated git flow release script
#
# Creates a new release with a UTC date-based tag (YYYYMMDD format)
# and pushes to trigger GitHub Actions build workflow.
#
# Usage:
#   ./scripts/release         # Normal release
#   ./scripts/release --force # Force re-release (deletes existing tag)

set -e  # Exit on error

# Parse arguments
FORCE=false
if [ "$1" = "--force" ] || [ "$1" = "-f" ]; then
    FORCE=true
fi

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
error() {
    echo -e "${RED}ERROR: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${BLUE}$1${NC}"
}

success() {
    echo -e "${GREEN}$1${NC}"
}

warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Not in a git repository"
fi

# Check if git flow is available
if ! command -v git-flow &> /dev/null; then
    error "git-flow is not installed. Install with: brew install git-flow (macOS) or apt-get install git-flow (Linux)"
fi

# Check if git flow is initialized
if ! git config --get gitflow.branch.master > /dev/null 2>&1; then
    warning "git-flow is not initialized in this repository"
    info "Initializing git-flow with default settings..."
    git flow init -d
fi

# Ensure we're on develop branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "develop" ]; then
    error "Must be on 'develop' branch. Currently on '$CURRENT_BRANCH'"
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    error "You have uncommitted changes. Please commit or stash them first."
fi

# Pull latest changes
info "Pulling latest changes from develop..."
git pull origin develop || error "Failed to pull from develop"

# Generate UTC date-based tag (YYYYMMDD format)
RELEASE_TAG=$(date -u '+%Y%m%d')
info "Release tag: $RELEASE_TAG"

# Check if tag already exists
if git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
    if [ "$FORCE" = false ]; then
        error "Tag '$RELEASE_TAG' already exists. A release has already been created today.\nUse --force to delete and recreate the release."
    else
        warning "Tag '$RELEASE_TAG' already exists. Force mode enabled - will delete and recreate."

        # Delete local tag
        info "Deleting local tag..."
        git tag -d "$RELEASE_TAG" 2>/dev/null || true

        # Delete remote tag
        info "Deleting remote tag..."
        git push origin ":refs/tags/$RELEASE_TAG" 2>/dev/null || true

        # Delete GitHub release if it exists (requires gh CLI)
        if command -v gh &> /dev/null; then
            info "Deleting GitHub release..."
            gh release delete "$RELEASE_TAG" --yes 2>/dev/null || warning "Release not found or could not be deleted"
        else
            warning "GitHub CLI (gh) not found. You may need to manually delete the GitHub release."
        fi

        success "Existing tag and release deleted"
    fi
fi

# Get the main branch name (could be 'main' or 'master')
MAIN_BRANCH=$(git config --get gitflow.branch.master || echo "main")
info "Main branch: $MAIN_BRANCH"

# Show what will happen
echo ""
info "=========================================="
info "Release Summary"
info "=========================================="
info "Release tag:    $RELEASE_TAG"
if [ "$FORCE" = true ]; then
    warning "Force mode:     ENABLED (will overwrite existing release)"
fi
info "Source branch:  develop"
info "Target branch:  $MAIN_BRANCH"
info "Current commit: $(git rev-parse --short HEAD)"
info "=========================================="
echo ""

# Confirm
if [ "$FORCE" = true ]; then
    read -p "This will OVERWRITE the existing release. Continue? (y/N): " -n 1 -r
else
    read -p "Proceed with release? (y/N): " -n 1 -r
fi
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    warning "Release cancelled"
    exit 0
fi

# Start git flow release
info "Starting git flow release $RELEASE_TAG..."
git flow release start "$RELEASE_TAG" || error "Failed to start release"

# Update version file if it exists (optional - create if you want to track versions)
# echo "$RELEASE_TAG" > VERSION

# Commit any release preparation changes
if ! git diff-index --quiet HEAD --; then
    info "Committing release preparation changes..."
    git add .
    git commit -m "Prepare release $RELEASE_TAG"
fi

# Finish git flow release
info "Finishing git flow release..."
# Use -m to provide tag message and avoid interactive editor
GIT_MERGE_AUTOEDIT=no git flow release finish -m "Release $RELEASE_TAG" "$RELEASE_TAG" || error "Failed to finish release"

success "Release $RELEASE_TAG completed locally"

# Push everything
info "Pushing branches and tags to origin..."
git push origin develop || error "Failed to push develop"
git push origin "$MAIN_BRANCH" || error "Failed to push $MAIN_BRANCH"
git push origin "$RELEASE_TAG" || error "Failed to push tag $RELEASE_TAG"

success "=========================================="
success "Release $RELEASE_TAG deployed successfully!"
success "=========================================="
info ""
info "GitHub Actions will now build the release."
info "Monitor progress at:"
info "  https://github.com/$(git config --get remote.origin.url | sed 's/.*://; s/.git$//')/actions"
info ""
info "Release will be available at:"
info "  https://github.com/$(git config --get remote.origin.url | sed 's/.*://; s/.git$//')/releases/tag/$RELEASE_TAG"
info ""
