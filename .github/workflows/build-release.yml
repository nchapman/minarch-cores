name: Build and Release Cores

on:
  push:
    tags:
      - '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'  # Match YYYYMMDD format (e.g., 20251115)

permissions:
  contents: write  # Required for creating releases and pushing tags

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max per CPU family
    strategy:
      matrix:
        cpu: [cortex-a7, cortex-a53]
      fail-fast: false  # Continue other builds even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: make docker-build

      - name: Clean previous builds
        run: make clean

      - name: Build ${{ matrix.cpu }}
        env:
          JOBS: 4
        run: |
          echo "Starting build for ${{ matrix.cpu }} at $(date)"
          make build-${{ matrix.cpu }}
          echo "Build completed at $(date)"

      - name: Verify build
        run: |
          count=$(ls output/${{ matrix.cpu }}/*.so 2>/dev/null | wc -l)
          echo "${{ matrix.cpu }}: $count cores built"
          if [ "$count" -eq 0 ]; then
            echo "ERROR: No cores built for ${{ matrix.cpu }}"
            exit 1
          fi

      - name: Package build
        run: make package-${{ matrix.cpu }}

      - name: Verify package
        run: |
          if [ -f "output/dist/linux-${{ matrix.cpu }}.zip" ]; then
            size=$(du -h "output/dist/linux-${{ matrix.cpu }}.zip" | cut -f1)
            echo "linux-${{ matrix.cpu }}.zip: $size"
          else
            echo "ERROR: output/dist/linux-${{ matrix.cpu }}.zip not found"
            exit 1
          fi

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.cpu }}
          path: output/dist/linux-${{ matrix.cpu }}.zip
          retention-days: 7

      - name: Save build info
        run: |
          count=$(ls output/${{ matrix.cpu }}/*.so 2>/dev/null | wc -l)
          echo "$count" > core-count-${{ matrix.cpu }}.txt

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.cpu }}
          path: core-count-${{ matrix.cpu }}.txt
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize artifacts
        run: |
          mkdir -p release-packages
          mv artifacts/linux-cortex-a7/linux-cortex-a7.zip release-packages/
          mv artifacts/linux-cortex-a53/linux-cortex-a53.zip release-packages/
          ls -lh release-packages/

      - name: Generate release notes
        id: release_notes
        run: |
          # Get core counts
          a7_count=$(cat artifacts/build-info-cortex-a7/core-count-cortex-a7.txt)
          a53_count=$(cat artifacts/build-info-cortex-a53/core-count-cortex-a53.txt)

          cat << EOF > release_notes.md
          # LessUI-Cores Build ${GITHUB_REF_NAME}

          Automated build of libretro cores for ARM-based retro handhelds running MinUI.

          ## Build Information
          - Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Tag: ${GITHUB_REF_NAME}
          - Commit: ${GITHUB_SHA:0:8}

          ## CPU Family Packages

          Download the package for your device's CPU family:

          | CPU Family | Architecture | Cores | Devices |
          |------------|--------------|-------|---------|
          | **cortex-a7** | ARM32 (ARMv7) | ${a7_count} | Miyoo Mini, A30 |
          | **cortex-a53** | ARM64 (ARMv8-a) | ${a53_count} | RG28xx/35xx/40xx, Trimui |

          ## Installation

          1. Download the appropriate .zip file for your device
          2. Extract the .so files to your MinUI cores directory
          3. Restart your device

          ## Systems Supported

          This build includes cores for ~35 retro gaming systems. See \`config/systems.yml\` for the complete list.

          ## Source

          All cores built from production-tested commits sourced from [Knulli](https://github.com/knulli-cfw/distribution).
          EOF

          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-packages/*.zip
          body_path: release_notes.md
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update 'latest' tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest
          git push -f origin latest
